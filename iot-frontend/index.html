<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IOT Hajju</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS CHUNG */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; overflow-x: hidden; }
        .header { background: #fff; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { margin: 0; font-size: 24px; color: #009879; text-transform: uppercase; letter-spacing: 1px; }
        .header i.logo { font-size: 28px; color: #009879; }
        .toolbar { background: #2c3e50; color: white; padding: 10px 30px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-btn { font-size: 20px; cursor: pointer; color: white; padding: 5px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .menu-btn:hover { background: rgba(255,255,255,0.1); }
        .current-view-title { font-weight: bold; text-transform: uppercase; font-size: 0.9em; opacity: 0.8; border-left: 1px solid #555; padding-left: 15px; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #1a252f; color: white; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 20px; background: #009879; font-weight: bold; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { cursor: pointer; font-size: 20px; color: white; opacity: 0.8; transition: 0.3s; background: rgba(0,0,0,0.1); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-btn:hover { opacity: 1; background: rgba(0,0,0,0.3); transform: rotate(90deg); }
        .menu-item { padding: 18px 25px; border-bottom: 1px solid #2c3e50; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; font-size: 1.05em; }
        .menu-item:hover { background: #2c3e50; padding-left: 30px; }
        .menu-item.active { background: #2c3e50; border-left: 5px solid #009879; color: #009879; font-weight: bold; }
        .menu-item i { width: 25px; text-align: center; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        
        /* NOTIFICATION */
        .notify-box { position: relative; cursor: pointer; }
        .notify-icon { font-size: 26px; color: #555; transition: 0.3s; }
        .notify-icon:hover { color: #009879; transform: scale(1.1); }
        .notify-badge { position: absolute; top: -6px; right: -6px; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; display: none; animation: popIn 0.3s; border: 2px solid white; }
        .notify-dropdown { position: absolute; top: 50px; right: 0; width: 360px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 1000; border: 1px solid #eee; max-height: 450px; overflow-y: auto; }
        .notify-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .notify-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #2c3e50; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .notify-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; flex-direction: column; gap: 4px; transition: 0.2s; }
        .notify-item:hover { background-color: #f9f9f9; }
        .n-row1 { display: flex; justify-content: space-between; font-size: 0.95em; font-weight: 600; color: #333; }
        .n-row2 { font-size: 0.85em; color: #7f8c8d; display: flex; justify-content: space-between; align-items: center; }
        .n-action { padding: 3px 8px; border-radius: 4px; font-size: 0.75em; color: white; text-transform: uppercase; font-weight: bold; }
        .act-on { background: #27ae60; } .act-off { background: #e74c3c; } .act-cam { background: #f39c12; } .act-add { background: #3498db; } .act-del { background: #95a5a6; }

        /* VIEWS */
        .section-view { display: none; padding: 30px; max-width: 1400px; margin: 0 auto; animation: slideUp 0.4s; }
        .section-view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* CONTROL LAYOUT */
        .control-layout { display: flex; gap: 30px; align-items: flex-start; }
        .control-left { flex: 3; }
        .control-right { flex: 1; min-width: 350px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-size: 20px; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .add-device-group { display: flex; gap: 10px; }
        .input-device-name { padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.3s; }
        .input-device-name:focus { border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        .btn-add { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { background: #2980b9; }

        .iot-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .iot-table th { background: #009879; color: white; padding: 15px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.9em; }
        .iot-table td { padding: 15px; border-bottom: 1px solid #eee; color: #555; }
        .cell-actions { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 500; transition: 0.2s; }
        .btn-on { background: #ecf0f1; color: #7f8c8d; } .btn-on.active { background: #2ecc71; color: white; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
        .btn-off { background: #ecf0f1; color: #7f8c8d; } .btn-off.active { background: #e74c3c; color: white; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4); }
        .btn-del { background: #fff0f0; color: #c0392b; padding: 8px 12px; } .btn-del:hover { background: #c0392b; color: white; }
        .btn-edit { background: #eaf2f8; color: #3498db; padding: 8px 12px; } .btn-edit:hover { background: #3498db; color: white; }

        /* SENSOR & GALLERY */
        .sensor-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #009879; }
        .sensor-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1em; padding-bottom: 5px; }
        .gallery-title { color: #c0392b; font-weight: bold; display: block; margin-top: 15px; margin-bottom: 10px; font-size: 0.95em; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .img-item { display: flex; align-items: center; gap: 15px; margin-top: 8px; cursor: pointer; background: #fff; padding: 8px; border: 1px solid #eee; border-radius: 8px; transition: 0.2s; position: relative; }
        .img-item:hover { transform: translateX(5px); border-color: #3498db; }
        .img-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; }
        .btn-download { margin-left: auto; border: none; cursor: pointer; background: #f1f2f6; color: #555; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; border: 1px solid #ddd; }
        .btn-download:hover { background: #3498db; color: white; border-color: #3498db; }

        /* TABLES */
        .history-row { display: none; background-color: #f8f9fa; } .history-row.open { display: table-row; }
        .history-content { padding: 20px !important; text-align: left !important; }
        .history-table { width: 100%; border: 1px solid #ddd; background: white; font-size: 0.9em; }
        .badge-on { color: green; font-weight: bold; } .badge-off { color: red; font-weight: bold; }
        .dev-table th { background: #8e44ad; } .pin-badge { background: #2c3e50; color: #f1c40f; padding: 5px 10px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: bold; font-size: 0.9em; }
        .notify-view-table th { background: #34495e; }
        .tag { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; color: white; font-weight: 500; }
        .tag-sys { background: #f39c12; } .tag-user { background: #3498db; }
        
        /* CHART STYLES */
        .charts-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .chart-card { flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-title { font-weight: bold; color: #555; margin-bottom: 15px; text-align: center; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* Stats Table Dropdown */
        .stats-main-row { cursor: pointer; transition: 0.2s; }
        .stats-main-row:hover { background: #f0fdfa; }
        .stats-detail-row { display: none; background: #fffcf5; }
        .stats-detail-row.open { display: table-row; }
        .detail-table { width: 100%; font-size: 0.9em; border: 1px dashed #ddd; margin-top: 10px; background: white; }
        .detail-table th { background: #f39c12; color: white; padding: 8px; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }

        @media (max-width: 900px) { .control-layout { flex-direction: column; } .control-right { width: 100%; } .charts-wrapper { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left"><i class="fas fa-network-wired logo"></i><h1>Dashboard IOT Hajju</h1></div>
        <div class="notify-box" onclick="toggleNotify()">
            <i class="fas fa-bell notify-icon"></i><span class="notify-badge" id="notify-count">0</span>
            <div class="notify-dropdown" id="notify-dropdown">
                <div class="notify-header"><span><i class="fas fa-history"></i> Hoạt động gần đây</span></div>
                <div id="notify-list">Đang tải...</div>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <div class="menu-btn" onclick="openMenu()"><i class="fas fa-bars"></i> Menu</div>
        <span class="current-view-title" id="page-title">Bảng điều khiển</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><span>HAJJU IOT</span><div class="close-btn" onclick="closeMenu()"><i class="fas fa-times"></i></div></div>
        <div class="menu-item active" onclick="switchView('control', this, 'Bảng điều khiển')"><i class="fas fa-tachometer-alt"></i> Bảng điều khiển</div>
        <div class="menu-item" onclick="switchView('stats', this, 'Thống kê & Biểu đồ')"><i class="fas fa-chart-pie"></i> Thống kê</div>
        <div class="menu-item" onclick="switchView('notification', this, 'Thông báo hệ thống')"><i class="fas fa-bell"></i> Thông báo</div>
        <div class="menu-item" onclick="switchView('development', this, 'Chế độ nhà phát triển')"><i class="fas fa-code"></i> Nhà phát triển</div>
    </div>

    <div id="view-control" class="section-view active">
        <div class="control-layout">
            <div class="control-left">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-sliders-h"></i> Điều khiển thiết bị</div>
                    <div class="add-device-group">
                        <input type="text" id="new-dev-name" class="input-device-name" placeholder="Tên thiết bị...">
                        <button class="btn-add" onclick="handleAddDevice()">+ Thêm</button>
                    </div>
                </div>
                <table class="iot-table">
                    <thead><tr><th>ID</th><th>Tên thiết bị</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                    <tbody id="control-body"></tbody>
                </table>
                <div style="margin-top:10px; color:#777; font-style:italic; font-size:0.9em">* Bấm vào dòng thiết bị để xem lịch sử chi tiết.</div>
            </div>
            <div class="control-right">
                <div class="panel-header"><div class="panel-title"><i class="fas fa-video"></i> Giám sát</div></div>
                <div id="sensor-body">Loading...</div>
            </div>
        </div>
    </div>

    <div id="view-stats" class="section-view">
        <div class="panel-header">
            <div class="panel-title"><i class="fas fa-chart-line"></i> Dữ liệu cảm biến</div>
            <button class="btn-add" onclick="loadCharts()"><i class="fas fa-sync"></i> Làm mới Biểu đồ</button>
        </div>
        <div style="margin-bottom: 10px; font-style: italic; color: #666; font-size: 0.9em;">* Biểu đồ tự động cập nhật mỗi 12 tiếng.</div>
        
        <div class="charts-wrapper">
            <div class="chart-card">
                <div class="chart-title">Chi tiết (5 phút / điểm)</div>
                <div class="chart-container"><canvas id="chart5m"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Tổng quan (1 giờ / cột)</div>
                <div class="chart-container"><canvas id="chart1h"></canvas></div>
            </div>
        </div>
        
        <div class="panel-header" style="margin-top: 30px;">
            <div class="panel-title"><i class="fas fa-history"></i> Thống kê Thời gian sử dụng</div>
        </div>
        <table class="iot-table">
            <thead><tr><th>Thiết bị</th><th>Trạng thái</th><th>Tổng thời gian chạy</th><th>Chi tiết</th></tr></thead>
            <tbody id="stats-body"></tbody>
        </table>
    </div>

    <div id="view-notification" class="section-view">
        <div class="panel-header"><div class="panel-title"><i class="fas fa-list-alt"></i> Nhật ký hệ thống</div><button class="btn-add" onclick="loadNotifications(true)"><i class="fas fa-sync"></i> Làm mới</button></div>
        <table class="iot-table notify-view-table"><thead><tr><th>Thời gian</th><th>Thiết bị</th><th>Hành động</th><th>Người dùng</th></tr></thead><tbody id="notify-body"><tr><td colspan="4">Đang tải...</td></tr></tbody></table>
    </div>

    <div id="view-development" class="section-view">
        <div class="panel-header"><div class="panel-title"><i class="fas fa-microchip"></i> Cấu hình GPIO (Phần cứng)</div></div>
        <div style="background: #fff; padding: 15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #8e44ad;"><i class="fas fa-info-circle" style="color:#8e44ad"></i> Trang này hiển thị ánh xạ phần cứng (Chân GPIO ESP32) tương ứng với từng thiết bị.</div>
        <table class="iot-table dev-table"><thead><tr><th>ID Thiết bị</th><th>Tên định danh</th><th>Chân GPIO (Output)</th><th>Trạng thái</th></tr></thead><tbody id="dev-body"></tbody></table>
    </div>

    <script>
        const API_BASE = "https://iot-vad5.onrender.com";
        function openMenu() { document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeMenu() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        function switchView(viewName, btn, title) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('page-title').innerText = title;
            closeMenu();
            if (viewName === 'notification') loadNotifications(true);
            if (viewName === 'stats') loadCharts();
        }

        let lastNotifySignature = ""; let lastViewedTimestamp = 0; let globalNotifications = []; let lastPirState = {}; let lastGallerySignature = {}; let openHistoryIds = new Set(); let lastHistoryData = {};
        
        let chart5m = null; let chart1h = null;
        function initCharts(data5m, data1h) {
            const ctx5m = document.getElementById('chart5m').getContext('2d');
            if(chart5m) chart5m.destroy();
            chart5m = new Chart(ctx5m, {
                type: 'line',
                data: { labels: data5m.map(d => d.time), datasets: [{ label: 'Nhiệt độ (°C)', data: data5m.map(d => d.temp), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, tension: 0.3, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
            const ctx1h = document.getElementById('chart1h').getContext('2d');
            if(chart1h) chart1h.destroy();
            chart1h = new Chart(ctx1h, {
                type: 'bar',
                data: { labels: data1h.map(d => d.time), datasets: [{ label: 'Nhiệt độ TB', data: data1h.map(d => d.temp), backgroundColor: '#e67e22', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
            });
        }

        async function loadCharts() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`); const data = await res.json();
                initCharts(data.chart_5m, data.chart_1h);
            } catch(e) { console.error("Lỗi chart"); }
        }

        // --- RENDER BẢNG THỜI GIAN (DROP DOWN) ---
        let openStatsIds = new Set(); 

        function toggleStats(id) {
            const row = document.getElementById(`stats-detail-${id}`);
            if (openStatsIds.has(id)) {
                openStatsIds.delete(id);
                row.classList.remove('open');
            } else {
                openStatsIds.add(id);
                row.classList.add('open');
            }
        }

        function renderStatsTable(devices) {
            const tbody = document.getElementById('stats-body');
            let html = "";
            devices.forEach(d => {
                let currentRun = 0;
                let statusText = d.status === "ON" ? `<span style="color:green;font-weight:bold">ĐANG CHẠY</span>` : `<span style="color:red">ĐÃ TẮT</span>`;
                if(d.status === "ON" && d.last_on_time) { currentRun = (Date.now()/1000) - d.last_on_time; }
                const totalSeconds = d.total_on_time + currentRun;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const totalTimeStr = `${hours}h ${minutes}m ${seconds}s`;

                let detailsHTML = `<div style="padding:10px; color:#999; text-align:center">Chưa có lịch sử sử dụng.</div>`;
                if ((d.usage_logs && d.usage_logs.length > 0) || d.status === "ON") {
                    detailsHTML = `<table class="detail-table"><thead><tr><th>Bắt đầu</th><th>Kết thúc</th><th>Thời lượng</th></tr></thead><tbody>`;
                    if (d.status === "ON") {
                        const curH = Math.floor(currentRun / 3600); const curM = Math.floor((currentRun % 3600) / 60); const curS = Math.floor(currentRun % 60);
                        const startTime = new Date(d.last_on_time * 1000).toLocaleTimeString();
                        detailsHTML += `<tr style="background:#e8f5e9; font-weight:bold; color:#27ae60"><td>${startTime}</td><td>Đang chạy...</td><td>${curH}h ${curM}m ${curS}s</td></tr>`;
                    }
                    if (d.usage_logs) {
                        d.usage_logs.forEach(log => {
                            const h = Math.floor(log.duration / 3600); const m = Math.floor((log.duration % 3600) / 60); const s = Math.floor(log.duration % 60);
                            detailsHTML += `<tr><td>${log.start}</td><td>${log.end}</td><td>${h}h ${m}m ${s}s</td></tr>`;
                        });
                    }
                    detailsHTML += `</tbody></table>`;
                }

                const isOpen = openStatsIds.has(d.id) ? 'open' : '';
                html += `
                    <tr class="stats-main-row" onclick="toggleStats(${d.id})">
                        <td style="font-weight:500">${d.name}</td>
                        <td>${statusText}</td>
                        <td style="font-weight:bold; color:#2c3e50">${totalTimeStr}</td>
                        <td><i class="fas fa-chevron-down" style="color:#aaa; transition:0.3s; transform: ${isOpen?'rotate(180deg)':''}"></i></td>
                    </tr>
                    <tr class="stats-detail-row ${isOpen}" id="stats-detail-${d.id}">
                        <td colspan="4" style="padding:0 !important; background:#f9f9f9"><div style="padding:15px; border-top:1px dashed #ddd">${detailsHTML}</div></td>
                    </tr>
                `;
            });
            if (tbody.innerHTML !== html) tbody.innerHTML = html;
        }

        function toggleNotify() {
            const dd = document.getElementById('notify-dropdown'); event.stopPropagation(); dd.classList.toggle('show');
            if (dd.classList.contains('show')) { if (globalNotifications.length > 0) lastViewedTimestamp = globalNotifications[0].ts; document.getElementById('notify-count').style.display = 'none'; }
        }

        async function updateDashboard() {
            try {
                const resDev = await fetch(`${API_BASE}/api/devices`); const devices = await resDev.json();
                const resNoti = await fetch(`${API_BASE}/api/notifications`); const notis = await resNoti.json();
                globalNotifications = notis;
                renderControlView(devices); renderSensorPanel(devices); renderDevelopmentView(devices); updateBell(notis);
                if(document.getElementById('view-notification').classList.contains('active')) { renderNotificationPage(notis); }
                if(document.getElementById('view-stats').classList.contains('active')) { renderStatsTable(devices); }
            } catch (e) { console.error(e); }
        }

        function renderControlView(devices) {
            const tbody = document.getElementById('control-body');
            if (devices.length === 0) { if(!tbody.innerHTML.includes("Chưa có thiết bị")) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999">Chưa có thiết bị</td></tr>'; return; }
            const newIds = devices.map(d => d.id);
            Array.from(tbody.getElementsByClassName('device-row')).forEach(row => { const rid = parseInt(row.getAttribute('data-id')); if (!newIds.includes(rid)) { row.remove(); document.getElementById(`history-${rid}`)?.remove(); } });

            devices.forEach(d => {
                const isOn = d.status === "ON";
                const statusBadge = isOn ? `<span style="color:green; font-weight:bold; background:#e8f5e9; padding:5px 10px; border-radius:15px">BẬT</span>` : `<span style="color:red; font-weight:bold; background:#ffebee; padding:5px 10px; border-radius:15px">TẮT</span>`;
                let row = document.getElementById(`row-${d.id}`); let histRow = document.getElementById(`history-${d.id}`);

                const actionsHtml = `
                    <button class="btn btn-on ${isOn?'active':''}" onclick="event.stopPropagation(); controlDevice(${d.id}, 'on')">Bật</button>
                    <button class="btn btn-off ${!isOn?'active':''}" onclick="event.stopPropagation(); controlDevice(${d.id}, 'off')">Tắt</button>
                    <div style="margin-left:auto; display:flex; gap:5px;">
                        <button class="btn btn-edit" onclick="event.stopPropagation(); renameDevice(${d.id}, '${d.name}')"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-del" onclick="event.stopPropagation(); deleteDevice(${d.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;

                if (!row) {
                    const tr = document.createElement("tr"); tr.className = "device-row"; tr.id = `row-${d.id}`; tr.setAttribute('data-id', d.id);
                    tr.onclick = () => toggleHistory(d.id);
                    tr.innerHTML = `<td><strong>#${d.id}</strong></td><td class="cell-name" style="font-weight:500; cursor:pointer">${d.name}</td><td class="cell-status">${statusBadge}</td><td class="cell-actions">${actionsHtml}</td>`;
                    tbody.appendChild(tr);
                    histRow = document.createElement("tr"); histRow.className = "history-row"; histRow.id = `history-${d.id}`; histRow.innerHTML = `<td colspan="4" class="history-content"><div id="hist-data-${d.id}">Đang tải...</div></td>`; tbody.appendChild(histRow);
                } else {
                    updateHTML(row.querySelector('.cell-name'), d.name);
                    updateHTML(row.querySelector('.cell-status'), statusBadge);
                    updateHTML(row.querySelector('.cell-actions'), actionsHtml);
                    if (!histRow) { histRow = document.createElement("tr"); histRow.className = "history-row"; histRow.id = `history-${d.id}`; histRow.innerHTML = `<td colspan="4" class="history-content"><div id="hist-data-${d.id}">Đang tải...</div></td>`; row.parentNode.insertBefore(histRow, row.nextSibling); }
                }
                if (openHistoryIds.has(d.id)) { if (!histRow.classList.contains('open')) histRow.classList.add('open'); fetchHistory(d.id); } else { if (histRow.classList.contains('open')) histRow.classList.remove('open'); }
            });
        }

        function renderSensorPanel(devices) {
            const container = document.getElementById('sensor-body'); let html = "";
            devices.forEach(d => {
                if (d.id !== 1) return; 
                if (lastPirState[d.id] === 0 && d.pir === 1) { Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: `CẢNH BÁO CÓ NGƯỜI`, showConfirmButton: false, timer: 3000, background: '#ffebee', color: '#c0392b' }); }
                lastPirState[d.id] = d.pir;
                const temp = d.temp ? d.temp : "--"; 
                const pirText = d.pir === 1 ? `<span style="color:#e74c3c; font-weight:bold"><i class="fas fa-running"></i> CÓ NGƯỜI</span>` : `<span style="color:#95a5a6">Không</span>`;
                
                let galleryHTML = `<span class="gallery-title" style="color:#aaa; font-weight:normal"><i class="fas fa-check-circle"></i> An toàn</span>`;
                if (d.pir === 1 || (d.images && d.images.length > 0)) { galleryHTML = `<span class="gallery-title"><i class="fas fa-exclamation-triangle"></i> CẢNH BÁO CÓ NGƯỜI</span>`; }

                if (d.images && d.images.length > 0) { 
                    d.images.forEach(img => {
                        const fullUrl = `${API_BASE}/static/${img.filename}`;
                        const downloadName = `capture_${img.time.replace(/[:\/ ]/g, '_')}.jpg`;
                        galleryHTML += `
                            <div class="img-item">
                                <img src="${fullUrl}" class="img-thumb" onclick="showImage('${fullUrl}', '${img.time}')">
                                <div style="font-size:0.9em; flex:1; cursor:pointer" onclick="showImage('${fullUrl}', '${img.time}')">
                                    <i class="far fa-clock"></i> ${img.time}<br>
                                    <span style="color:#e74c3c; font-size:0.8em; font-weight:bold">Phát hiện</span>
                                </div>
                                <button class="btn-download" onclick="downloadImage('${fullUrl}', '${downloadName}')" title="Tải ảnh">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        `; 
                    }); 
                } else if (d.pir === 1) { galleryHTML += `<div style="font-size:0.9em; color:#e74c3c; font-style:italic">Đang chờ ảnh từ camera...</div>`; }

                html += `<div class="sensor-card"><div class="sensor-row"><span><i class="fas fa-temperature-high" style="color:#e74c3c"></i> Nhiệt độ</span><span style="font-weight:bold; color:#333">${temp}°C</span></div><div class="sensor-row"><span><i class="fas fa-eye" style="color:#3498db"></i> Chuyển động</span><span>${pirText}</span></div><div style="margin-top:20px; padding-top:15px">${galleryHTML}</div></div>`;
            });
            if (container.innerHTML !== html) container.innerHTML = html;
        }

        function downloadImage(url, filename) { event.stopPropagation(); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function updateBell(data) { let unreadCount = 0; data.forEach(item => { if (item.ts > lastViewedTimestamp) unreadCount++; }); const badge = document.getElementById('notify-count'); if (unreadCount > 0) { badge.innerText = unreadCount > 9 ? '9+' : unreadCount; badge.style.display = 'block'; } else { badge.style.display = 'none'; } const currentSig = JSON.stringify(data); if (currentSig === lastNotifySignature) return; lastNotifySignature = currentSig; const listDiv = document.getElementById('notify-list'); if (data.length === 0) { listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999">Chưa có thông báo</div>'; return; } let html = ''; data.forEach(item => { let cls = 'act-on'; let displayName = item.name; if(item.action === 'OFF') cls = 'act-off'; if(item.action === 'CHỤP ẢNH') { cls = 'act-cam'; displayName = "Cảm biến có người"; } if(item.action.includes('THÊM')) cls = 'act-add'; if(item.action.includes('XÓA')) cls = 'act-del'; html += `<div class="notify-item"><div class="n-row1"><span>${displayName} <small style="color:#aaa">#${item.id}</small></span><span class="n-action ${cls}">${item.action}</span></div><div class="n-row2"><span><i class="far fa-user"></i> ${item.user}</span><span><i class="far fa-clock"></i> ${item.time}</span></div></div>`; }); listDiv.innerHTML = html; }
        function renderNotificationPage(notis) { const tbody = document.getElementById('notify-body'); if (notis.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px">Chưa có dữ liệu</td></tr>'; return; } let html = ""; notis.forEach(n => { let badgeClass = "tag-user"; if (n.user === "System") badgeClass = "tag-sys"; let rowColor = ""; if (n.action.includes("CHỤP")) rowColor = "background:#fffbf0"; let displayName = n.name; if(n.action === 'CHỤP ẢNH') displayName = "Cảm biến có người"; html += `<tr style="${rowColor}"><td style="color:#555">${n.time}</td><td style="font-weight:500">${displayName} <small style="color:#999">#${n.id}</small></td><td style="font-weight:bold">${n.action}</td><td><span class="tag ${badgeClass}">${n.user}</span></td></tr>`; }); if (tbody.innerHTML !== html) tbody.innerHTML = html; }
        function renderDevelopmentView(devices) { const tbody = document.getElementById('dev-body'); let html = ""; devices.forEach(d => { const pinDisplay = d.pin ? d.pin : "N/A"; html += `<tr><td><strong>#${d.id}</strong></td><td>${d.name}</td><td><span class="pin-badge">GPIO ${pinDisplay}</span></td><td style="font-weight:bold; color: ${d.status==='ON'?'green':'red'}">${d.status}</td></tr>`; }); if (tbody.innerHTML !== html) tbody.innerHTML = html; }
        function updateHTML(el, html) { if (el && el.innerHTML !== html) el.innerHTML = html; }
        function toggleHistory(id) { const row = document.getElementById(`history-${id}`); if(openHistoryIds.has(id)){ openHistoryIds.delete(id); } else { openHistoryIds.add(id); fetchHistory(id); } }
        
        async function fetchHistory(id) { 
            const div = document.getElementById(`hist-data-${id}`); if(!div) return; 
            try { 
                const res = await fetch(`${API_BASE}/api/devices/${id}/history`); 
                const allLogs = await res.json(); 
                
                // --- LỌC BỎ CHỤP ẢNH ---
                const logs = allLogs.filter(l => l.action !== "CHỤP ẢNH");

                const currentDataString = JSON.stringify(logs); 
                if (lastHistoryData[id] === currentDataString && !div.innerHTML.includes("Đang tải")) return; 
                lastHistoryData[id] = currentDataString; 
                
                if(logs.length === 0){ div.innerHTML = "<i>Chưa có lịch sử.</i>"; return; } 
                
                let h = `<table class="history-table"><thead><tr><th>Giờ</th><th>Hành động</th><th>User</th></tr></thead><tbody>`; 
                logs.forEach(l => { 
                    const cls = l.action.includes('ON') ? 'badge-on' : 'badge-off'; 
                    h += `<tr><td>${l.time}</td><td class="${cls}">${l.action}</td><td>${l.user}</td></tr>` 
                }); 
                h += `</tbody></table>`; 
                div.innerHTML = h; 
            } catch(e) { console.log("Lỗi fetch history"); } 
        }

        // --- ACTIONS ---
        async function handleAddDevice() { const name = document.getElementById('new-dev-name').value; if(!name) return Swal.fire("Lỗi", "Vui lòng nhập tên", "error"); await fetch(`${API_BASE}/api/devices`, {method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({name: name})}); document.getElementById('new-dev-name').value = ""; updateDashboard(); Swal.fire("Thành công", "Đã thêm thiết bị", "success"); }
        async function controlDevice(id, action) { await fetch(`${API_BASE}/api/devices/${id}/${action}`, {method: "POST"}); updateDashboard(); }
        function deleteDevice(id) { Swal.fire({ title: 'Xóa thiết bị?', text: "", icon: 'warning', showCancelButton: true, confirmButtonText: 'Xóa ngay', cancelButtonText: 'Hủy', confirmButtonColor: '#e74c3c' }).then(async (res) => { if (res.isConfirmed) { await fetch(`${API_BASE}/api/devices/${id}`, {method: "DELETE"}); updateDashboard(); Swal.fire("Đã xóa", "", "success"); } }); }
        function showImage(url, title) { Swal.fire({ imageUrl: url, imageAlt: 'Evidence', title: title, width: 600, showConfirmButton: false }); }
        function renameDevice(id, oldName) { Swal.fire({ title: 'Đổi tên thiết bị', input: 'text', inputValue: oldName, showCancelButton: true, confirmButtonText: 'Lưu', cancelButtonText: 'Hủy', inputValidator: (value) => { if (!value) return 'Tên không được để trống!' } }).then(async (result) => { if (result.isConfirmed) { await fetch(`${API_BASE}/api/devices/${id}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name: result.value }) }); updateDashboard(); Swal.fire('Đã cập nhật', '', 'success'); } }); }

        // 12 GIỜ = 43,200,000 ms
        setInterval(loadCharts, 43200000); 
        
        updateDashboard(); 
        setInterval(updateDashboard, 1000); 
        window.onclick = function(event) { if (!event.target.closest('.notify-box') && !event.target.closest('.notify-dropdown')) { document.getElementById('notify-dropdown').classList.remove('show'); } }
    </script>
</body>
</html>
