<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IOT Hajju</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === CSS GI·ªÆ NGUY√äN === */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; color: #333; overflow-x: hidden; }
        .header { background: #fff; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { margin: 0; font-size: 24px; color: #009879; text-transform: uppercase; letter-spacing: 1px; }
        .header i.logo { font-size: 28px; color: #009879; }
        .toolbar { background: #2c3e50; color: white; padding: 10px 30px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-btn { font-size: 20px; cursor: pointer; color: white; padding: 5px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .menu-btn:hover { background: rgba(255,255,255,0.1); }
        .current-view-title { font-weight: bold; text-transform: uppercase; font-size: 0.9em; opacity: 0.8; border-left: 1px solid #555; padding-left: 15px; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #1a252f; color: white; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 20px; background: #009879; font-weight: bold; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { cursor: pointer; font-size: 20px; color: white; opacity: 0.8; transition: 0.3s; background: rgba(0,0,0,0.1); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-btn:hover { opacity: 1; background: rgba(0,0,0,0.3); transform: rotate(90deg); }
        .menu-item { padding: 18px 25px; border-bottom: 1px solid #2c3e50; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 15px; font-size: 1.05em; }
        .menu-item:hover { background: #2c3e50; padding-left: 30px; }
        .menu-item.active { background: #2c3e50; border-left: 5px solid #009879; color: #009879; font-weight: bold; }
        .menu-item i { width: 25px; text-align: center; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .notify-box { position: relative; cursor: pointer; margin-right: 10px; }
        .notify-icon { font-size: 26px; color: #555; transition: 0.3s; display: inline-block; }
        .notify-icon:hover { color: #009879; }
        .notify-badge { position: absolute; top: -6px; right: -6px; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; display: none; animation: popIn 0.3s; border: 2px solid white; }
        .notify-dropdown { position: absolute; top: 50px; right: 0; width: 360px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; z-index: 1000; border: 1px solid #eee; max-height: 450px; overflow-y: auto; }
        .notify-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .notify-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: #2c3e50; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .notify-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; flex-direction: column; gap: 4px; transition: 0.2s; }
        .notify-item:hover { background-color: #f9f9f9; }
        .n-row1 { display: flex; justify-content: space-between; font-size: 0.95em; font-weight: 600; color: #333; }
        .n-row2 { font-size: 0.85em; color: #7f8c8d; display: flex; justify-content: space-between; align-items: center; }
        .n-action { padding: 3px 8px; border-radius: 4px; font-size: 0.75em; color: white; text-transform: uppercase; font-weight: bold; }
        .act-on { background: #27ae60; } .act-off { background: #e74c3c; } .act-cam { background: #f39c12; } .act-add { background: #3498db; } .act-del { background: #95a5a6; }
        .section-view { display: none; padding: 30px; max-width: 1400px; margin: 0 auto; animation: slideUp 0.4s; }
        .section-view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .control-layout { display: flex; gap: 30px; align-items: flex-start; }
        .control-left { flex: 3; } .control-right { flex: 1; min-width: 350px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-size: 20px; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .add-device-group { display: flex; gap: 10px; }
        .input-device-name { padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.3s; }
        .input-device-name:focus { border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        .btn-add { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { background: #2980b9; }
        .iot-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .iot-table th { background: #009879; color: white; padding: 15px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.9em; }
        .iot-table td { padding: 15px; border-bottom: 1px solid #eee; color: #555; }
        .cell-actions { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 500; transition: 0.2s; }
        .btn-on { background: #ecf0f1; color: #7f8c8d; } .btn-on.active { background: #2ecc71; color: white; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
        .btn-off { background: #ecf0f1; color: #7f8c8d; } .btn-off.active { background: #e74c3c; color: white; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4); }
        .btn-del { background: #fff0f0; color: #c0392b; padding: 8px 12px; } .btn-del:hover { background: #c0392b; color: white; }
        .btn-edit { background: #eaf2f8; color: #3498db; padding: 8px 12px; } .btn-edit:hover { background: #3498db; color: white; }
        .sensor-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #009879; }
        .sensor-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1em; padding-bottom: 5px; }
        .warning-alert { background-color: #fdede9; color: #c0392b; padding: 12px 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; }
        .warning-alert:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .warning-alert .icon { font-size: 24px; color: #e74c3c; }
        .warning-alert .message { font-weight: 700; text-transform: uppercase; font-size: 0.95em; letter-spacing: 0.5px; }
        .safe-alert { background-color: #f0fdf4; color: #155724; padding: 12px 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; margin-top: 15px; }
        .safe-alert .icon { font-size: 24px; color: #28a745; }
        .safe-alert .message { font-weight: 600; font-size: 0.95em; }
        .img-item { display: flex; align-items: center; gap: 15px; margin-top: 8px; cursor: pointer; background: #fff; padding: 8px; border: 1px solid #eee; border-radius: 8px; transition: 0.2s; position: relative; }
        .img-item:hover { transform: translateX(5px); border-color: #3498db; }
        .img-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; }
        .btn-download { margin-left: auto; border: none; cursor: pointer; background: #f1f1f6; color: #555; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; border: 1px solid #ddd; }
        .btn-download:hover { background: #3498db; color: white; border-color: #3498db; }
        .gallery-container { margin-top: 5px; padding-top: 5px; }
        .gallery-content { display: none; max-height: 300px; overflow-y: auto; padding-top: 10px; }
        .gallery-content.open { display: block; }
        .history-row { display: none; background-color: #f8f9fa; } .history-row.open { display: table-row; }
        .history-content { padding: 20px !important; text-align: left !important; }
        .history-table { width: 100%; border: 1px solid #ddd; background: white; font-size: 0.9em; }
        .badge-on { color: green; font-weight: bold; } .badge-off { color: red; font-weight: bold; }
        .dev-table th { background: #8e44ad; } .pin-badge { background: #2c3e50; color: #f1c40f; padding: 5px 10px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: bold; font-size: 0.9em; }
        .notify-view-table th { background: #34495e; }
        .tag { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; color: white; font-weight: 500; }
        .tag-sys { background: #f39c12; } .tag-user { background: #3498db; }
        .charts-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .chart-card { flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-title { font-weight: bold; color: #555; margin-bottom: 15px; text-align: center; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .stats-main-row { cursor: pointer; transition: 0.2s; }
        .stats-main-row:hover { background: #f0fdfa; }
        .stats-detail-row { display: none; background: #fffcf5; }
        .stats-detail-row.open { display: table-row; }
        .detail-table { width: 100%; font-size: 0.9em; border: 1px dashed #ddd; margin-top: 10px; background: white; }
        .detail-table th { background: #f39c12; color: white; padding: 8px; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .camera-snapshot-box { background: black; border-radius: 10px; width: 100%; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; margin-bottom: 15px; }
        .latest-image, #videoStreamElement { width: 100%; height: 100%; object-fit: contain; }
        .no-image-text { color: #7f8c8d; text-align: center; }
        .stream-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-stream { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-stream-on { background: #2ecc71; }
        .btn-stream-on:hover { background: #27ae60; }
        .btn-stream-off { background: #e74c3c; opacity: 0.5; pointer-events: none; }
        .streaming-active .btn-stream-on { opacity: 0.5; pointer-events: none; }
        .streaming-active .btn-stream-off { opacity: 1; pointer-events: auto; background: #e74c3c; }
        .streaming-active .btn-stream-off:hover { background: #c0392b; }
        @keyframes bell-shake { 0% { transform: rotate(0); } 15% { transform: rotate(5deg); } 30% { transform: rotate(-5deg); } 45% { transform: rotate(4deg); } 60% { transform: rotate(-4deg); } 100% { transform: rotate(0); } }
        @media (max-width: 900px) { .control-layout { flex-direction: column; } .control-right { width: 100%; } .charts-wrapper { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left"><i class="fas fa-network-wired logo"></i><h1>Dashboard IOT Hajju</h1></div>
        <div class="notify-box" onclick="toggleNotify(event)">
            <i class="fas fa-bell notify-icon" id="bell-icon"></i><span class="notify-badge" id="notify-count">0</span>
            <div class="notify-dropdown" id="notify-dropdown">
                <div class="notify-header">
                    <span><i class="fas fa-history"></i> M·ªõi nh·∫•t</span>
                    <span style="float:right; cursor:pointer; color:#e74c3c; font-size:0.9em;" onclick="clearNotifications()">
                        <i class="fas fa-trash-alt"></i> X√≥a
                    </span>
                </div>
                <div id="notify-list">ƒêang t·∫£i...</div>
            </div>
        </div>
    </div>

        <div class="toolbar">
        <div class="menu-btn" onclick="openMenu()"><i class="fas fa-bars"></i> Menu</div>
        <span class="current-view-title" id="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
    </div>

    <div class="overlay" id="overlay" onclick="closeMenu()"></div>
    
<div id="view-account" class="section-view">
    <div class="control-layout" style="display: flex; 
                                       flex-direction: row; 
                                       gap: 30px; 
                                       width: 100%; /* Chi·∫øm tr·ªçn chi·ªÅu ngang */
                                       margin: 20px 0; 
                                       align-items: flex-start;">
        
        <div style="flex: 1;">
            <div class="panel-header"><div class="panel-title" style="color: #009879;"><i class="fas fa-id-badge"></i> Th√¥ng tin t√†i kho·∫£n</div></div>
            <div class="sensor-card" style="border-top: 4px solid #009879; padding: 25px; height: 100%;">
                <div class="sensor-row" style="font-size: 1.1em; padding-bottom: 15px;">
                    <span><i class="fas fa-envelope" style="color: #3498db;"></i> Email ƒëƒÉng nh·∫≠p:</span>
                    <span style="font-weight:bold; color: #2c3e50;" id="acc-email">ƒêang t·∫£i...</span>
                </div>
                <div class="sensor-row" style="font-size: 1.1em; padding-bottom: 15px;">
                    <span><i class="fas fa-id-card" style="color: #7f8c8d;"></i> M√£ ng∆∞·ªùi d√πng (ID):</span>
                    <span style="font-weight:bold" id="acc-id">--</span>
                </div>
                <div class="sensor-row" style="font-size: 1.1em; border-bottom: none;">
                    <span><i class="fas fa-user-tag" style="color: #2ecc71;"></i> Vai tr√≤:</span>
                    <span style="font-weight:bold; color:green">Admin (Mockup)</span>
                </div>
                
                <button class="btn btn-off" style="width:100%; margin-top:30px; 
                                                  background:#e74c3c; color:white; 
                                                  font-size: 1.1em; padding: 12px;
                                                  border-radius: 6px; box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);" 
                        onclick="handleLogout()">ƒêƒÉng xu·∫•t <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        
        <div style="flex: 1;">
            <div class="panel-header"><div class="panel-title" style="color: #8e44ad;"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</div></div>
            <div class="sensor-card" style="border-top: 4px solid #8e44ad; padding: 25px;">
                <form id="change-pass-form">
                    <div class="input-group" style="margin-bottom:20px">
                        <label for="old-pass" style="display:block; font-weight:600; margin-bottom:8px">M·∫≠t kh·∫©u c≈©</label>
                        <input type="password" id="old-pass" style="width:100%; padding:14px; border:1px solid #ddd; border-radius:6px; background: #f9f9f9;" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                    </div>
                    <div class="input-group" style="margin-bottom:20px">
                        <label for="new-pass" style="display:block; font-weight:600; margin-bottom:8px">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="new-pass" style="width:100%; padding:14px; border:1px solid #ddd; border-radius:6px; background: #f9f9f9;" required placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
                    </div>
                    <div class="input-group" style="margin-bottom:30px">
                        <label for="confirm-pass" style="display:block; font-weight:600; margin-bottom:8px">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="confirm-pass" style="width:100%; padding:14px; border:1px solid #ddd; border-radius:6px; background: #f9f9f9;" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                    </div>
                    
                    <button type="submit" class="btn btn-add" style="width:100%; background:#8e44ad; 
                                                                font-size: 1.1em; padding: 14px;
                                                                border-radius: 6px; box-shadow: 0 4px 8px rgba(142, 68, 173, 0.3);">
                        ƒê·ªïi M·∫≠t Kh·∫©u
                    </button>
                </form>
            </div>
        </div>

    </div>
</div>

    <div class="overlay" id="overlay" onclick="closeMenu()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><span>HAJJU IOT</span><div class="close-btn" onclick="closeMenu()"><i class="fas fa-times"></i></div></div>
        <div class="menu-item" onclick="switchView('account', this, 'T√†i kho·∫£n ng∆∞·ªùi d√πng')"><i class="fas fa-user-circle"></i> T√†i kho·∫£n</div>
        <div class="menu-item active" onclick="switchView('control', this, 'B·∫£ng ƒëi·ªÅu khi·ªÉn')"><i class="fas fa-tachometer-alt"></i> B·∫£ng ƒëi·ªÅu khi·ªÉn</div>
        <div class="menu-item" onclick="switchView('camera', this, 'Camera AI')"><i class="fas fa-video"></i> Camera AI</div>
        <div class="menu-item" onclick="switchView('stats', this, 'Th·ªëng k√™ & Bi·ªÉu ƒë·ªì')"><i class="fas fa-chart-pie"></i> Th·ªëng k√™</div>
        <div class="menu-item" onclick="switchView('notification', this, 'Th√¥ng b√°o h·ªá th·ªëng')"><i class="fas fa-bell"></i> Th√¥ng b√°o</div>
        <div class="menu-item" onclick="switchView('development', this, 'Ch·∫ø ƒë·ªô nh√† ph√°t tri·ªÉn')"><i class="fas fa-code"></i> Nh√† ph√°t tri·ªÉn</div>
    </div>

    <div id="view-control" class="section-view active">
        <div class="control-layout">
            <div class="control-left">
                <div class="panel-header">
                    <div class="panel-title"><i class="fas fa-sliders-h"></i> ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</div>
                    <div class="add-device-group">
                        <input type="text" id="new-dev-name" class="input-device-name" placeholder="T√™n thi·∫øt b·ªã...">
                        <button class="btn-add" onclick="handleAddDevice()">+ Th√™m</button>
                    </div>
                </div>
                <table class="iot-table">
                    <thead><tr><th>ID</th><th>T√™n thi·∫øt b·ªã</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
                    <tbody id="control-body"></tbody>
                </table>
                <div style="margin-top:10px; color:#777; font-style:italic; font-size:0.9em">* B·∫•m v√†o d√≤ng thi·∫øt b·ªã ƒë·ªÉ xem l·ªãch s·ª≠ B·∫¨T/T·∫ÆT chi ti·∫øt.</div>
            </div>
            
            <div class="control-right">
                <div class="panel-header"><div class="panel-title"><i class="fas fa-video"></i> Gi√°m s√°t t·∫°i ch·ªó</div></div>
                <div id="sensor-body-local">Loading...</div>
                <div class="panel-header" style="margin-top: 20px;"><div class="panel-title"><i class="fas fa-broadcast-tower"></i> D·ªØ li·ªáu T·ª´ Xa</div></div>
                <div id="sensor-body-remote">Loading...</div>
            </div>
        </div>
    </div>

    <div id="view-camera" class="section-view">
        <div class="control-layout">
            <div class="control-left">
                <div class="panel-header"><div class="panel-title"><i class="fas fa-satellite-dish"></i> Live Stream (Th·ªùi gian th·ª±c)</div></div>
                <div class="stream-controls" id="streamControls">
                    <button class="btn-stream btn-stream-on" onclick="startStream()"><i class="fas fa-play"></i> B·∫¨T STREAM</button>
                    <button class="btn-stream btn-stream-off" onclick="stopStream()"><i class="fas fa-stop"></i> T·∫ÆT STREAM</button>
                </div>
                <div class="camera-snapshot-box" style="border: 2px solid #3498db;">
                    <img id="videoStreamElement" src="" style="display:none">
                    <div id="streamPlaceholder" class="no-image-text">
                        <i class="fas fa-video-slash" style="font-size:50px; margin-bottom:10px; color: #95a5a6"></i><br>
                        Camera ƒëang t·∫Øt ƒë·ªÉ ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng
                    </div>
                </div>
            </div>
            
            <div class="control-right">
                <div class="panel-header"><div class="panel-title"><i class="fas fa-camera-retro"></i> ·∫¢nh Ch·ª•p G·∫ßn Nh·∫•t</div></div>
                <div class="camera-snapshot-box">
                    <img id="latest-snapshot" class="latest-image" src="" style="display:none">
                    <div id="no-snapshot" class="no-image-text">
                        <i class="fas fa-image" style="font-size:40px; margin-bottom:10px"></i><br>Ch∆∞a c√≥ ·∫£nh
                    </div>
                </div>
                <div style="text-align:center; color:#555; margin-bottom:20px">
                    <i class="far fa-clock"></i> <span id="snapshot-time" style="font-weight:bold">--/--</span>
                </div>
                <div class="panel-header"><div class="panel-title"><i class="fas fa-info-circle"></i> Tr·∫°ng th√°i</div></div>
                <div class="sensor-card" style="border-top:4px solid #3498db">
                    <div style="font-size:0.95em; color:#555">
                        <p>‚Ä¢ Ch·∫ø ƒë·ªô: <b>Always On Guard</b></p>
                        <p>‚Ä¢ Stream: <b id="status-stream" style="color:red">ƒêANG T·∫ÆT</b></p>
                        <p style="font-style:italic; font-size:0.9em">* H·ªá th·ªëng t·ª± ƒë·ªông ph√°t hi·ªán ng∆∞·ªùi v√† ch·ª•p ·∫£nh (3s/l·∫ßn) ngay c·∫£ khi t·∫Øt Stream.</p>
                    </div>
                </div>
                <button class="btn-add" style="width:100%; margin-top:10px; background:#e67e22" onclick="forceCapture()">üì∏ CH·ª§P ·∫¢NH NGAY</button>
            </div>
        </div>
    </div>

    <div id="view-stats" class="section-view">
        <div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> D·ªØ li·ªáu c·∫£m bi·∫øn</div><button class="btn-add" onclick="loadCharts()"><i class="fas fa-sync"></i> L√†m m·ªõi Bi·ªÉu ƒë·ªì</button></div>
        <div class="charts-wrapper"><div class="chart-card" id="card-5m"><div class="chart-title">Chi ti·∫øt (5 ph√∫t / ƒëi·ªÉm)</div><div class="chart-container"><canvas id="chart5m"></canvas></div></div><div class="chart-card" id="card-1h"><div class="chart-title">T·ªïng quan (1 gi·ªù / c·ªôt)</div><div class="chart-container"><canvas id="chart1h"></canvas></div></div></div>
        <div class="panel-header" style="margin-top: 30px;"><div class="panel-title"><i class="fas fa-history"></i> Th·ªëng k√™ Th·ªùi gian s·ª≠ d·ª•ng</div></div>
        <table class="iot-table"><thead><tr><th>Thi·∫øt b·ªã</th><th>Tr·∫°ng th√°i</th><th>T·ªïng th·ªùi gian ch·∫°y</th><th>Chi ti·∫øt</th></tr></thead><tbody id="stats-body"></tbody></table>
    </div>

    <div id="view-notification" class="section-view">
        <div class="panel-header"><div class="panel-title"><i class="fas fa-list-alt"></i> Nh·∫≠t k√Ω h·ªá th·ªëng</div><button class="btn-add" onclick="loadNotifications(true)"><i class="fas fa-sync"></i> L√†m m·ªõi</button></div>
        <table class="iot-table notify-view-table"><thead><tr><th>Th·ªùi gian</th><th>Thi·∫øt b·ªã</th><th>H√†nh ƒë·ªông</th><th>Ng∆∞·ªùi d√πng</th></tr></thead><tbody id="notify-body"><tr><td colspan="4">ƒêang t·∫£i...</td></tr></tbody></table>
    </div>

    <div id="view-development" class="section-view"><div class="panel-header"><div class="panel-title"><i class="fas fa-microchip"></i> C·∫•u h√¨nh GPIO (Ph·∫ßn c·ª©ng)</div></div><div style="background: #fff; padding: 15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #8e44ad;"><i class="fas fa-info-circle" style="color:#8e44ad"></i> Trang n√†y hi·ªÉn th·ªã √°nh x·∫° ph·∫ßn c·ª©ng (Ch√¢n GPIO ESP32) t∆∞∆°ng ·ª©ng v·ªõi t·ª´ng thi·∫øt b·ªã.</div><table class="iot-table dev-table"><thead><tr><th>ID Thi·∫øt b·ªã</th><th>T√™n ƒë·ªãnh danh</th><th>Ch√¢n GPIO (Output)</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody id="dev-body"></tbody></table></div>

    <script>
        const API_BASE = ""; 
        const CAM_BASE = "http://localhost:5001";

        // BI·∫æN TO√ÄN C·ª§C
        let currentView = "control";
        let lastSeenImageTime = localStorage.getItem('lastSeenImageTime') || '00:00:00 01/01';
        let isGalleryOpen = false;
        let lastNotifySignature = ""; 
        let lastViewedTimestamp = 0; 
        let globalNotifications = []; 
        let lastPirState = {}; 
        let openHistoryIds = new Set(); 
        let openStatsIds = new Set();
        let chart5m = null; 
        let chart1h = null;

        // --- MENU LOGIC ---
        function openMenu() { document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeMenu() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }

        function switchView(viewName, btn, title) {
            currentView = viewName;

            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('page-title').innerText = title;
            closeMenu();

            // Load d·ªØ li·ªáu t∆∞∆°ng ·ª©ng
            if (viewName === 'control') updateDashboard();
            if (viewName === 'account') loadAccountInfo();
            if (viewName === 'stats') loadCharts();
            if (viewName !== 'camera') stopStream();
        }

        // --- AUTHENTICATION CHECK ---
        async function checkLogin() {
            try {
                const res = await fetch("/api/user_status", { credentials: "include" });
                const data = await res.json();
                if (!data.logged_in) {
                    window.location.href = "/"; // Chuy·ªÉn v·ªÅ login n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                }
            } catch (e) {
                window.location.href = "/";
            }
        }

        async function handleLogout() {
            try {
                await fetch('/logout', { method: 'POST', credentials: 'include' });
            } finally {
                window.location.href = '/';
            }
        }

        // --- ACCOUNT LOGIC ---
        async function loadAccountInfo() {
            try {
                const res = await fetch(`${API_BASE}/api/user_info`, { credentials: "include" });
                
                if (res.status === 200) {
                    const userInfo = await res.json();
                    const emailElem = document.getElementById('acc-email');
                    const idElem = document.getElementById('acc-id');
                    
                    if(emailElem) emailElem.innerText = userInfo.email;
                    if(idElem) idElem.innerText = `#${userInfo.id}`;
                } else if (res.status === 401) {
                    window.location.href = '/'; 
                }
            } catch (e) {
                console.error("L·ªói t·∫£i th√¥ng tin t√†i kho·∫£n:", e);
            }
        }

        // --- CHANGE PASSWORD LOGIC ---
        const changePassForm = document.getElementById('change-pass-form');
        if (changePassForm) {
            changePassForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const oldPass = document.getElementById('old-pass').value;
                const newPass = document.getElementById('new-pass').value;
                const confirmPass = document.getElementById('confirm-pass').value;

                if (newPass.length < 6) return Swal.fire("L·ªói", "M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.", "error");
                if (newPass !== confirmPass) return Swal.fire("L·ªói", "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.", "error");

                try {
                    const response = await fetch('/change_password', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_password: oldPass, new_password: newPass })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        Swal.fire("Th√†nh c√¥ng!", result.message, "success");
                        changePassForm.reset();
                    } else {
                        Swal.fire("Th·∫•t b·∫°i", result.message, "error");
                    }
                } catch (error) {
                    Swal.fire("L·ªói k·∫øt n·ªëi", "Kh√¥ng th·ªÉ k·∫øt n·ªëi server.", "error");
                }
            });
        }

        // --- CORE UPDATE FUNCTION ---
        async function updateDashboard() { 
            if (currentView !== "control" && currentView !== "notification") return;
            try { 
                const resDev = await fetch(`${API_BASE}/api/devices`, { credentials: "include" });
                const devices = await resDev.json();
                
                if(document.getElementById('view-notification').classList.contains('active')) { 
                    const resAll = await fetch(`${API_BASE}/api/notifications`, { credentials: "include" });
                    const allNotis = await resAll.json();
                    renderNotificationPage(allNotis);
                } 

                const resDrop = await fetch(`${API_BASE}/api/notifications/dropdown`, { credentials: "include" });
                const dropNotis = await resDrop.json();
                
                renderControlView(devices); 
                renderSensorPanel(devices); 
                renderDevelopmentView(devices); 
                updateBell(dropNotis); 
                
                if(document.getElementById('view-stats').classList.contains('active')) { renderStatsTable(devices); } 
            } catch (e) { console.error(e); } 
        }

        // --- RENDER CONTROL VIEW (FIXED) ---
        function renderControlView(devices) {
            const tbody = document.getElementById('control-body');
            if (devices.length === 0) { 
                if(!tbody.innerHTML.includes("Ch∆∞a c√≥ thi·∫øt b·ªã")) 
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999">Ch∆∞a c√≥ thi·∫øt b·ªã</td></tr>'; 
                return; 
            }
            
            const newIds = devices.map(d => d.id);
            Array.from(tbody.getElementsByClassName('device-row')).forEach(row => { 
                const rid = parseInt(row.getAttribute('data-id')); 
                if (!newIds.includes(rid)) { 
                    row.remove(); 
                    document.getElementById(`history-${rid}`)?.remove(); 
                } 
            });

            let html = '';
            devices.forEach(d => {
                const isOn = d.status === "ON";
                const statusBadge = isOn 
                    ? `<span style="color:green; font-weight:bold; background:#e8f5e9; padding:5px 10px; border-radius:15px">B·∫¨T</span>` 
                    : `<span style="color:red; font-weight:bold; background:#ffebee; padding:5px 10px; border-radius:15px">T·∫ÆT</span>`;
                
                // N√∫t thao t√°c (KH√îNG C√ì GPIO)
                const actionsHtml = `
                    <div style="display: flex; align-items: center; gap: 5px; justify-content: flex-end;">
                        <button class="btn btn-on ${isOn?'active':''}" onclick="event.stopPropagation(); controlDevice(${d.id}, 'on')">B·∫≠t</button>
                        <button class="btn btn-off ${!isOn?'active':''}" onclick="event.stopPropagation(); controlDevice(${d.id}, 'off')">T·∫Øt</button>
                        
                        <button class="btn" style="background:#3498db; padding: 8px 12px;" onclick="event.stopPropagation(); renameDevice(${d.id}, '${d.name}')" title="ƒê·ªïi t√™n">
                            <i class="fas fa-edit"></i>
                        </button>
                        
                        <button class="btn btn-del" onclick="event.stopPropagation(); deleteDevice(${d.id})" title="X√≥a thi·∫øt b·ªã">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                
                // HI·ªÇN TH·ªä T√äN THI·∫æT B·ªä (KH√îNG C√ì GPIO)
                html += `
                <tr class="device-row" onclick="toggleHistory(${d.id})">
                    <td><strong>#${d.id}</strong></td>
                    <td class="cell-name" style="font-weight:500; cursor:pointer">
                        ${d.name} 
                    </td>
                    <td class="cell-status">${statusBadge}</td>
                    <td class="cell-actions">${actionsHtml}</td>
                </tr>
                <tr class="history-row" id="history-${d.id}">
                    <td colspan="4" class="history-content"><div id="hist-data-${d.id}"></div></td>
                </tr>`;
            });
            
            if (tbody.innerHTML !== html) tbody.innerHTML = html;
        }

        async function fetchHistory(id) { 
            const div = document.getElementById(`hist-data-${id}`); 
            if(!div) return; 
            
            if (!div.querySelector('table') && !div.innerHTML.includes("Ch∆∞a c√≥")) {
                div.innerHTML = '<div style="padding:10px; color:#666; text-align:center"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';
            }

            try {
                const res = await fetch(`${API_BASE}/api/devices/${id}/history`, { credentials: "include" }); 
                const logs = await res.json();
                
                if(logs.length === 0){ 
                    div.innerHTML = "<div style='padding:10px; color:#999; font-style:italic; text-align:center'>Ch∆∞a c√≥ l·ªãch s·ª≠ ho·∫°t ƒë·ªông.</div>"; 
                    return; 
                } 
                
                let h = `<table class="history-table"><thead><tr><th style="background:#34495e; color:white">Th·ªùi gian</th><th style="background:#34495e; color:white">H√†nh ƒë·ªông</th><th style="background:#34495e; color:white">Ng∆∞·ªùi d√πng</th></tr></thead><tbody>`; 
                logs.forEach(l => { 
                    let statusClass = ""; let actionText = l.action;
                    if(l.action === "ON") { statusClass = "badge-on"; actionText = "B·∫¨T"; }
                    else if(l.action === "OFF") { statusClass = "badge-off"; actionText = "T·∫ÆT"; }
                    h += `<tr><td><i class="far fa-clock"></i> ${l.time}</td><td class="${statusClass}" style="font-weight:bold">${actionText}</td><td><i class="far fa-user"></i> ${l.user}</td></tr>`; 
                }); 
                h += `</tbody></table>`; 
                div.innerHTML = h; 
            } catch(e) { console.error(e); } 
        }

        function toggleHistory(id) { 
            const row = document.getElementById(`history-${id}`); 
            if(openHistoryIds.has(id)){ openHistoryIds.delete(id); row.classList.remove('open'); } 
            else { openHistoryIds.add(id); row.classList.add('open'); fetchHistory(id); } 
        }

        function renderStatsTable(devices) { 
            const tbody = document.getElementById('stats-body'); 
            let html = ""; 
            devices.forEach(d => { 
                let currentRun = 0; let statusBadge = '<span style="color:#95a5a6">ƒê√£ t·∫Øt</span>';
                if(d.status === "ON") {
                    statusBadge = '<span class="badge-on">ƒêANG CH·∫†Y</span>';
                    if (d.last_on_time) currentRun = (Date.now()/1000) - d.last_on_time; 
                }
                const totalSeconds = d.total_on_time + currentRun; 
                const h = Math.floor(totalSeconds / 3600); 
                const m = Math.floor((totalSeconds % 3600) / 60); 
                const s = Math.floor(totalSeconds % 60); 
                const totalTimeStr = `${h}h ${m}m ${s}s`; 

                let detailsHTML = `<div style="padding:10px; color:#999; text-align:center; font-style:italic">Ch∆∞a c√≥ d·ªØ li·ªáu s·ª≠ d·ª•ng.</div>`; 
                if ((d.usage_logs && d.usage_logs.length > 0) || d.status === "ON") { 
                    detailsHTML = `<table class="detail-table"><thead><tr><th>B·∫Øt ƒë·∫ßu</th><th>K·∫øt th√∫c</th><th>Th·ªùi l∆∞·ª£ng</th></tr></thead><tbody>`; 
                    if (d.status === "ON") { 
                        const curH = Math.floor(currentRun / 3600); const curM = Math.floor((currentRun % 3600) / 60); const curS = Math.floor(currentRun % 60);
                        const startTime = new Date(d.last_on_time * 1000).toLocaleTimeString(); 
                        detailsHTML += `<tr style="background:#e8f5e9; font-weight:bold; color:#27ae60"><td>${startTime}</td><td>Running...</td><td>${curH}h ${curM}m ${curS}s</td></tr>`; 
                    } 
                    if (d.usage_logs) { 
                        d.usage_logs.forEach(log => { 
                            const duration = Math.round(log.duration);
                            const lh = Math.floor(duration / 3600); const lm = Math.floor((duration % 3600) / 60); const ls = duration % 60;
                            detailsHTML += `<tr><td>${log.start}</td><td>${log.end}</td><td>${lh}h ${lm}m ${ls}s</td></tr>`; 
                        }); 
                    } 
                    detailsHTML += `</tbody></table>`; 
                } 
                const isOpen = openStatsIds.has(d.id) ? 'open' : ''; 
                const iconClass = isOpen ? 'fa-chevron-up' : 'fa-chevron-down';
                html += `<tr class="stats-main-row" onclick="toggleStats(${d.id})"><td style="font-weight:500"><strong>#${d.id}</strong> - ${d.name}</td><td>${statusBadge}</td><td style="font-weight:bold; color:#2c3e50">${totalTimeStr}</td><td><i class="fas ${iconClass}" style="color:#aaa; transition:0.3s;"></i></td></tr><tr class="stats-detail-row ${isOpen}" id="stats-detail-${d.id}"><td colspan="4" style="padding:0 !important; background:#fffcf5"><div style="padding:15px; border-top:1px dashed #ddd">${detailsHTML}</div></td></tr>`; 
            }); 
            if (tbody.innerHTML !== html) tbody.innerHTML = html; 
        }

        function toggleStats(id) { 
            const row = document.getElementById(`stats-detail-${id}`); 
            if (openStatsIds.has(id)) { openStatsIds.delete(id); row.classList.remove('open'); } 
            else { openStatsIds.add(id); row.classList.add('open'); }
            updateDashboard();
        }

        function renderSensorPanel(devices) {
            const containerLocal = document.getElementById('sensor-body-local'); 
            const containerRemote = document.getElementById('sensor-body-remote');
            if (!devices || devices.length === 0) return;
            const d = devices[0]; 

            const tempLocal = (d.temp && d.temp !== "--") ? d.temp.toFixed(1) + "¬∞C" : "--";
            const humLocal = (d.hum && d.hum !== "--") ? d.hum.toFixed(1) + "%" : "--";
            const pirText = d.pir === 1 ? `<span style="color:#e74c3c; font-weight:bold"><i class="fas fa-running"></i> C√ì NG∆Ø·ªúI</span>` : `<span style="color:#95a5a6">Kh√¥ng</span>`;
            
            const tempRemote = (d.temp2 && d.temp2 !== "--") ? d.temp2.toFixed(1) + "¬∞C" : "--";
            const humRemote = (d.hum2 && d.hum2 !== "--") ? d.hum2.toFixed(1) + "%" : "--";
            const gasRemote = (d.gas && d.gas !== "--") ? d.gas : "--";
            
            if (lastPirState[d.id] === 0 && d.pir === 1) { 
                Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'C·∫¢NH B√ÅO C√ì NG∆Ø·ªúI !', showConfirmButton: false, timer: 3000, timerProgressBar: true, background: '#fdede9', color: '#c0392b', iconColor: '#e74c3c' }); 
                const bell = document.getElementById('bell-icon'); bell.classList.add('shake'); setTimeout(() => bell.classList.remove('shake'), 500);
            }
            lastPirState[d.id] = d.pir;

            let galleryHeader = d.pir === 1 || (d.images && d.images.length > 0) ? `<div class="warning-alert" onclick="toggleGallery()"><i class="fas fa-exclamation-circle icon"></i><span class="message">C·∫¢NH B√ÅO C√ì NG∆Ø·ªúI</span><i class="fas ${isGalleryOpen ? 'fa-chevron-up' : 'fa-chevron-down'}" id="gallery-toggle-icon" style="margin-left:auto; color:#c0392b"></i></div>` : `<div class="safe-alert"><i class="fas fa-check-circle icon"></i><span class="message">KHU V·ª∞C AN TO√ÄN</span></div>`;
            
            let galleryContent = `<div class="gallery-content" id="gallery-content"></div>`; 
            let contentHtml = '';
            let latestImageTime = '00:00:00 01/01';

            if (d.images && d.images.length > 0) {
                const latestImg = d.images[0];
                const fullUrl = `${API_BASE}/static/${latestImg.filename}`;
                const camImg = document.getElementById('latest-snapshot');
                const camNoImg = document.getElementById('no-snapshot');
                const camTime = document.getElementById('snapshot-time');
                if(camImg && camNoImg) { camImg.src = fullUrl; camImg.style.display = 'block'; camNoImg.style.display = 'none'; camTime.innerText = latestImg.time; }
                latestImageTime = latestImg.time;
                d.images.forEach(img => { const url = `${API_BASE}/static/${img.filename}`; const name = `capture_${img.time.replace(/[:\/ ]/g, '_')}.jpg`; contentHtml += `<div class="img-item"><img src="${url}" class="img-thumb" onclick="showImage('${url}', '${img.time}')"><div style="font-size:0.9em; flex:1; cursor:pointer" onclick="showImage('${url}', '${img.time}')"><i class="far fa-clock"></i> ${img.time}<br><span style="color:#e74c3c; font-size:0.8em; font-weight:bold">Ph√°t hi·ªán</span></div><button class="btn-download" onclick="downloadImage('${url}', '${name}')" title="T·∫£i ·∫£nh"><i class="fas fa-download"></i></button></div>`; }); 
                galleryContent = `<div class="gallery-content ${isGalleryOpen ? 'open' : ''}" id="gallery-content">${contentHtml}</div>`;
            } else if (d.pir === 1) { galleryContent = `<div class="gallery-content open" id="gallery-content"><div style="font-size:0.9em; color:#e74c3c; font-style:italic; padding:10px">ƒêang ch·ªù ·∫£nh t·ª´ camera...</div></div>`; }

            const htmlLocal = `<div class="sensor-card"><div class="sensor-row"><span><i class="fas fa-temperature-high" style="color:#e74c3c"></i> Nhi·ªát ƒë·ªô</span><span style="font-weight:bold; color:#333">${tempLocal}</span></div><div class="sensor-row"><span><i class="fas fa-tint" style="color:#3498db"></i> ƒê·ªô ·∫©m</span><span style="font-weight:bold; color:#333">${humLocal}</span></div><div class="sensor-row"><span><i class="fas fa-eye" style="color:#2ecc71"></i> Chuy·ªÉn ƒë·ªông</span><span>${pirText}</span></div><div class="gallery-container">${galleryHeader}${galleryContent}<input type="hidden" id="gallery-latest-time" value="${latestImageTime}"></div></div>`;
            const htmlRemote = `<div class="sensor-card" style="border-top: 4px solid #8e44ad;"><div class="sensor-row"><span><i class="fas fa-temperature-high" style="color:#e74c3c"></i> Nhi·ªát ƒë·ªô</span><span style="font-weight:bold; color:#333">${tempRemote}</span></div><div class="sensor-row"><span><i class="fas fa-tint" style="color:#3498db"></i> ƒê·ªô ·∫©m</span><span style="font-weight:bold; color:#333">${humRemote}</span></div><div class="sensor-row"><span><i class="fas fa-burn" style="color:#d35400"></i> Kh√≠ Gas</span><span style="font-weight:bold; color:#333">${gasRemote}</span></div></div>`;
            
            if (containerLocal.innerHTML !== htmlLocal) containerLocal.innerHTML = htmlLocal;
            if (containerRemote.innerHTML !== htmlRemote) containerRemote.innerHTML = htmlRemote;
        }

        // --- NOTIFICATIONS, DEV VIEW, OTHER UTILS ---
        
        function updateBell(data) { 
            const unreadCount = data.length;
            const badge = document.getElementById('notify-count'); 
            if (unreadCount > 0) { badge.innerText = unreadCount > 9 ? '9+' : unreadCount; badge.style.display = 'block'; const bell = document.getElementById('bell-icon'); if (JSON.stringify(data) !== lastNotifySignature) { bell.classList.add('shake'); setTimeout(() => bell.classList.remove('shake'), 500); } } else { badge.style.display = 'none'; } 
            const currentSig = JSON.stringify(data); if (currentSig === lastNotifySignature) return; lastNotifySignature = currentSig; 
            const listDiv = document.getElementById('notify-list'); 
            if (data.length === 0) { listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-style:italic">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>'; return; } 
            let html = ''; data.forEach(item => { let cls = 'act-on'; let displayName = item.name; if(item.action === 'OFF') cls = 'act-off'; if(item.action.includes('CH·ª§P') || item.action.includes('PH√ÅT HI·ªÜN')) { cls = 'act-cam'; } if(item.action.includes('TH√äM')) cls = 'act-add'; if(item.action.includes('X√ìA')) cls = 'act-del'; html += `<div class="notify-item"><div class="n-row1"><span>${displayName}</span><span class="n-action ${cls}">${item.action}</span></div><div class="n-row2"><span><i class="far fa-clock"></i> ${item.time}</span></div></div>`; }); listDiv.innerHTML = html; 
        }

        function toggleNotify(event) { 
            if (event) event.stopPropagation(); 
            const dd = document.getElementById('notify-dropdown'); 
            dd.classList.toggle('show'); 
            if (dd.classList.contains('show')) { 
                if (globalNotifications.length > 0) { lastViewedTimestamp = globalNotifications[0].ts; } 
                document.getElementById('notify-count').style.display = 'none'; 
            } 
        }

        async function clearNotifications() { try { await fetch(`${API_BASE}/api/notifications/clear`, { method: "POST" }); document.getElementById('notify-dropdown').classList.remove('show'); updateDashboard(); const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500}); Toast.fire({icon: 'success', title: 'ƒê√£ x√≥a th√¥ng b√°o'}); } catch(e) { console.error("L·ªói x√≥a th√¥ng b√°o"); } }
        function renderNotificationPage(notis) { const tbody = document.getElementById('notify-body'); if (notis.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; } let html = ""; notis.forEach(n => { let badgeClass = "tag-user"; if (n.user === "System") badgeClass = "tag-sys"; let rowColor = ""; if (n.action.includes("CH·ª§P") || n.action.includes("PH√ÅT HI·ªÜN")) rowColor = "background:#fffbf0"; let displayName = n.name; html += `<tr style="${rowColor}"><td style="color:#555">${n.time}</td><td style="font-weight:500">${displayName} <small style="color:#999">#${n.id}</small></td><td style="font-weight:bold">${n.action}</td><td><span class="tag ${badgeClass}">${n.user}</span></td></tr>`; }); if (tbody.innerHTML !== html) tbody.innerHTML = html; }

        function renderDevelopmentView(devices) { const tbody = document.getElementById('dev-body'); let html = ""; devices.forEach(d => { const pinDisplay = d.pin ? d.pin : "N/A"; html += `<tr><td><strong>#${d.id}</strong></td><td>${d.name}</td><td><span class="pin-badge">GPIO ${pinDisplay}</span></td><td style="font-weight:bold; color: ${d.status==='ON'?'green':'red'}">${d.status}</td></tr>`; }); if (tbody.innerHTML !== html) tbody.innerHTML = html; }
        
        // --- H√ÄM X·ª¨ L√ù N√öT B·∫§M ---
        function updateHTML(el, html) { if (el && el.innerHTML !== html) el.innerHTML = html; }
        async function handleAddDevice() { const name = document.getElementById('new-dev-name').value; if(!name) return Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p t√™n", "error"); await fetch(`${API_BASE}/api/devices`, {method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({name: name})}); document.getElementById('new-dev-name').value = ""; updateDashboard(); Swal.fire("Th√†nh c√¥ng", "ƒê√£ th√™m thi·∫øt b·ªã", "success"); }
        async function controlDevice(id, action) { await fetch(`${API_BASE}/api/devices/${id}/${action}`, {method: "POST"}, {credentials: "include"}); updateDashboard(); }
        
        function deleteDevice(id) {
            Swal.fire({
                title: 'B·∫°n ch·∫Øc ch·∫Øn?',
                text: "Thi·∫øt b·ªã s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† GPIO s·∫Ω ƒë∆∞·ª£c thu h·ªìi!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a ngay!',
                cancelButtonText: 'H·ªßy'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`${API_BASE}/api/devices/${id}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            Swal.fire('ƒê√£ x√≥a!', 'Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c g·ª° b·ªè.', 'success');
                            updateDashboard();
                        } else {
                            Swal.fire('L·ªói', data.message, 'error');
                        }
                    } catch (e) {
                        Swal.fire('L·ªói k·∫øt n·ªëi', '', 'error');
                    }
                }
            })
        }

        async function renameDevice(id, oldName) {
            const { value: newName } = await Swal.fire({
                title: 'ƒê·ªïi t√™n thi·∫øt b·ªã',
                input: 'text',
                inputLabel: 'Nh·∫≠p t√™n m·ªõi',
                inputValue: oldName,
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'B·∫°n ch∆∞a nh·∫≠p t√™n m·ªõi!'
                    }
                }
            })

            if (newName) {
                try {
                    const res = await fetch(`${API_BASE}/api/devices/${id}/rename`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                    const data = await res.json();
                    if (data.success) {
                        Swal.fire('Th√†nh c√¥ng', 'T√™n thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
                        updateDashboard();
                    } else {
                        Swal.fire('L·ªói', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('L·ªói k·∫øt n·ªëi', '', 'error');
                }
            }
        }

        function initCharts(data5m, data1h) {
            const ctx5m = document.getElementById('chart5m').getContext('2d'); if(chart5m) chart5m.destroy(); chart5m = new Chart(ctx5m, { type: 'line', data: { labels: data5m.map(d => d.time), datasets: [{ label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: data5m.map(d => d.temp), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } } });
            const ctx1h = document.getElementById('chart1h').getContext('2d'); if(chart1h) chart1h.destroy(); chart1h = new Chart(ctx1h, { type: 'bar', data: { labels: data1h.map(d => d.time), datasets: [{ label: 'Nhi·ªát ƒë·ªô TB', data: data1h.map(d => d.temp), backgroundColor: '#e67e22', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } } });
        }
        async function loadCharts() { try { const res = await fetch(`${API_BASE}/api/stats`, {credentials: "include"}); const data = await res.json(); initCharts(data.chart_5m, data.chart_1h); } catch(e) { console.error("L·ªói chart"); } }

        const videoEl = document.getElementById('videoStreamElement');
        const streamPlaceholder = document.getElementById('streamPlaceholder');
        const streamControls = document.getElementById('streamControls');
        const statusStreamTxt = document.getElementById('status-stream');
        function startStream() { const timestamp = new Date().getTime(); videoEl.src = `${CAM_BASE}/video_feed?t=${timestamp}`; videoEl.style.display = 'block'; streamPlaceholder.style.display = 'none'; streamControls.classList.add('streaming-active'); statusStreamTxt.innerHTML = '<span style="color:green; font-weight:bold">ƒêANG B·∫¨T LIVE</span>'; }
        function stopStream() { videoEl.src = ""; videoEl.style.display = 'none'; streamPlaceholder.style.display = 'block'; streamControls.classList.remove('streaming-active'); statusStreamTxt.innerHTML = '<span style="color:red; font-weight:bold">ƒêANG T·∫ÆT</span>'; }
        function toggleGallery() { const content = document.getElementById('gallery-content'); const icon = document.getElementById('gallery-toggle-icon'); isGalleryOpen = !isGalleryOpen; if (isGalleryOpen) { content.classList.add('open'); icon.classList.replace('fa-chevron-down', 'fa-chevron-up'); updateDashboard(); } else { content.classList.remove('open'); icon.classList.replace('fa-chevron-up', 'fa-chevron-down'); } }
        function downloadImage(url, filename) { event.stopPropagation(); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function showImage(url, timestamp) { Swal.fire({ imageUrl: url, imageAlt: 'Evidence', title: timestamp, width: 600, showConfirmButton: false }); lastSeenImageTime = timestamp; localStorage.setItem('lastSeenImageTime', timestamp); updateDashboard(); }

        setInterval(loadCharts, 43200000); 
        
        window.onclick = function(event) { 
            if (!event.target.closest('.notify-box') && !event.target.closest('.notify-dropdown')) { 
                const dd = document.getElementById('notify-dropdown'); 
                if (dd && dd.classList.contains('show')) {
                    dd.classList.remove('show'); 
                    if (globalNotifications.length > 0) { lastViewedTimestamp = globalNotifications[0].ts; }
                    updateDashboard(); 
                }
            } 
            if (!event.target.closest('.sidebar') && !event.target.closest('.menu-btn') && document.getElementById('sidebar').classList.contains('active')) {
                closeMenu();
            }
        } 
        
        (async () => {
            await checkLogin(); 
            updateDashboard();
            setInterval(() => {
                if (currentView === "control" || currentView === "notification") {
                    updateDashboard();
                }
            }, 1000);
        })();
    </script>
</body>
</html>
